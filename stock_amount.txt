SELECT
I.CODE AS 'STOCK_CODE' ,
I.NAME AS 'STOK_NAME',
(SELECT TOP 1 UNITSTL.CODE  FROM  
                         dbo.LG_XXX_UNITSETF AS UNITSTF INNER JOIN  dbo.LG_XXX_UNITSETL AS UNITSTL ON UNITSTF.LOGICALREF = UNITSTL.UNITSETREF 
                         INNER JOIN  dbo.LG_XXX_ITEMS AS ITEMS ON UNITSTF.LOGICALREF = I.UNITSETREF ) AS UNIT,

SUM((CASE WHEN S.IOCODE in (1,2) THEN COALESCE(
CASE S.UINFO1
WHEN 0 THEN S.AMOUNT
ELSE S.AMOUNT*S.UINFO2/S.UINFO1
END, S.AMOUNT) ELSE 0 END)
) 
 AS 'SUM_IN',

SUM((CASE WHEN S.IOCODE not in (1,2) THEN COALESCE(
CASE S.UINFO1
WHEN 0 THEN S.AMOUNT
ELSE S.AMOUNT*S.UINFO2/S.UINFO1
END, S.AMOUNT) ELSE 0 END)
) 'SUM_OUT',
(
select (
SUM((CASE WHEN S.IOCODE in (1,2) THEN COALESCE(
CASE S.UINFO1
WHEN 0 THEN S.AMOUNT
ELSE S.AMOUNT*S.UINFO2/S.UINFO1
END, S.AMOUNT) ELSE 0 END)
) 
-
SUM((CASE WHEN S.IOCODE not in (1,2) THEN COALESCE(
CASE S.UINFO1
WHEN 0 THEN S.AMOUNT
ELSE S.AMOUNT*S.UINFO2/S.UINFO1
END, S.AMOUNT) ELSE 0 END)
) 

) )AS 'STOCK',

from LG_XXX_ITEMS AS I 
LEFT JOIN LG_XXX_01_STLINE AS S ON I.LOGICALREF=S.STOCKREF AND I.ACTIVE='0' and S.CANCELLED='0' 
LEFT JOIN LG_XXX_01_INVOICE AS F ON S.INVOICEREF=F.LOGICALREF 
LEFT JOIN LG_XXX_01_STFICHE SF ON  SF.LOGICALREF=S.STFICHEREF 
LEFT JOIN LG_XXX_01_STINVTOT AS ST ON I.LOGICALREF=ST.STOCKREF
GROUP BY I.CODE,I.NAME,I.STGRPCODE,I.SPECODE,I.LOGICALREF,I.UNITSETREF
Order By I.CODE
